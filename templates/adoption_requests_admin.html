<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adoption Requests Management - RocKaRan Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-pending { color: #856404; background-color: #fff3cd; }
        .status-approved { color: #155724; background-color: #d4edda; }
        .status-rejected { color: #721c24; background-color: #f8d7da; }
        .request-card { border: 1px solid #e9ecef; border-radius: 10px; padding: 20px; margin-bottom: 20px; transition: box-shadow 0.3s ease; }
        .request-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-home me-2"></i>
                RocKaRan Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin">Cats</a>
                <a class="nav-link" href="/admin/articles">Articles</a>
                <a class="nav-link" href="/admin/adoption-questions">Questions</a>
                <a class="nav-link active" href="/admin/adoption-requests">Requests</a>
                <a class="nav-link" href="/admin/logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-clipboard-list me-2"></i>Adoption Requests</h1>
            <button class="btn btn-success" onclick="exportRequests()">
                <i class="fas fa-download me-2"></i>Export CSV
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4" id="stats">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-primary">Total</h5>
                        <h2 id="totalRequests">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-warning">Pending</h5>
                        <h2 id="pendingRequests">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-success">Approved</h5>
                        <h2 id="approvedRequests">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-danger">Rejected</h5>
                        <h2 id="rejectedRequests">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Requests List -->
        <div id="requestsList">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Details Modal -->
    <div class="modal fade" id="requestModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adoption Request Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="requestDetails">
                    <!-- Request details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="approveBtn" onclick="updateStatus('approved')">Approve</button>
                    <button type="button" class="btn btn-danger" id="rejectBtn" onclick="updateStatus('rejected')">Reject</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentRequestId = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadRequests();
        });

        async function loadRequests() {
            try {
                const response = await fetch('/api/adoption/requests');
                const requests = await response.json();
                displayRequests(requests);
                updateStats(requests);
            } catch (error) {
                console.error('Error loading requests:', error);
                document.getElementById('requestsList').innerHTML = '<div class="alert alert-danger">Error loading requests</div>';
            }
        }

        function updateStats(requests) {
            const stats = {
                total: requests.length,
                pending: requests.filter(r => r.status === 'pending').length,
                approved: requests.filter(r => r.status === 'approved').length,
                rejected: requests.filter(r => r.status === 'rejected').length
            };

            document.getElementById('totalRequests').textContent = stats.total;
            document.getElementById('pendingRequests').textContent = stats.pending;
            document.getElementById('approvedRequests').textContent = stats.approved;
            document.getElementById('rejectedRequests').textContent = stats.rejected;
        }

        function displayRequests(requests) {
            const container = document.getElementById('requestsList');

            if (requests.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No adoption requests yet.</div>';
                return;
            }

            container.innerHTML = requests.map(request => `
                <div class="request-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5>${request.customer_name}</h5>
                            <p class="mb-1"><strong>Email:</strong> ${request.customer_email}</p>
                            ${request.phone ? `<p class="mb-1"><strong>Phone:</strong> ${request.phone}</p>` : ''}
                            <p class="mb-1"><strong>Submitted:</strong> ${new Date(request.submitted_at).toLocaleDateString()}</p>
                            <p class="mb-1"><strong>Subscription:</strong> ${request.subscription ? 'Yes' : 'No'}</p>
                        </div>
                        <div class="text-end">
                            <span class="badge ${getStatusClass(request.status)} p-2 mb-2">${request.status.toUpperCase()}</span>
                            <br>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewRequest(${request.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getStatusClass(status) {
            switch(status) {
                case 'pending': return 'status-pending';
                case 'approved': return 'status-approved';
                case 'rejected': return 'status-rejected';
                default: return 'bg-secondary';
            }
        }

        async function viewRequest(requestId) {
            try {
                const response = await fetch(`/api/adoption/requests/${requestId}`);
                const request = await response.json();

                currentRequestId = requestId;

                const details = document.getElementById('requestDetails');
                const customAnswers = JSON.parse(request.custom_answers || '{}');

                details.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Contact Information</h6>
                            <p><strong>Name:</strong> ${request.customer_name}</p>
                            <p><strong>Email:</strong> ${request.customer_email}</p>
                            ${request.phone ? `<p><strong>Phone:</strong> ${request.phone}</p>` : ''}
                            <p><strong>Submitted:</strong> ${new Date(request.submitted_at).toLocaleString()}</p>
                            <p><strong>Status:</strong> <span class="badge ${getStatusClass(request.status)}">${request.status.toUpperCase()}</span></p>
                            <p><strong>Terms Agreed:</strong> ${request.terms_agreed ? 'Yes' : 'No'}</p>
                            <p><strong>Newsletter:</strong> ${request.subscription ? 'Yes' : 'No'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Questionnaire Responses</h6>
                            ${Object.keys(customAnswers).length > 0 ?
                                Object.entries(customAnswers).map(([key, value]) =>
                                    `<p><strong>Question ${key}:</strong> ${value}</p>`
                                ).join('') :
                                '<p>No responses recorded.</p>'
                            }
                        </div>
                    </div>
                `;

                // Update button states
                const approveBtn = document.getElementById('approveBtn');
                const rejectBtn = document.getElementById('rejectBtn');

                if (request.status === 'pending') {
                    approveBtn.style.display = 'inline-block';
                    rejectBtn.style.display = 'inline-block';
                } else {
                    approveBtn.style.display = 'none';
                    rejectBtn.style.display = 'none';
                }

                new bootstrap.Modal(document.getElementById('requestModal')).show();
            } catch (error) {
                console.error('Error loading request details:', error);
                alert('Error loading request details');
            }
        }

        async function updateStatus(status) {
            if (!currentRequestId) return;

            try {
                const response = await fetch(`/api/adoption/requests/${currentRequestId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({status: status})
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('requestModal')).hide();
                    loadRequests();
                    showAlert(`Request ${status} successfully!`, 'success');
                } else {
                    showAlert('Error updating request status', 'danger');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showAlert('Error updating request status', 'danger');
            }
        }

        function exportRequests() {
            // Simple CSV export - in production, you'd want server-side generation
            window.location.href = '/api/adoption/requests/export';
        }

        function showAlert(message, type) {
            // Simple alert - could be enhanced with Bootstrap alerts
            alert(message);
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
