<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adoption Request - LavanderCats Cat Farm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'beige': '#F5F5DC',
                        'warm-beige': '#F0E8D8',
                        'soft-gray': '#E5E5E5',
                        'dusty-rose': '#D4A4A4',
                        'muted-pink': '#E8D5D5'
                    }
                }
            }
        }
    </script>
</head>
<body>
<style>
    [x-cloak] { display: none !important; }
</style>

<script>
function formModals() {
    return {
        termsModalOpen: false,
        privacyModalOpen: false,
        termsContent: '',
        privacyContent: '',
        async loadTerms() {
            if (this.termsContent) {
                this.termsModalOpen = true;
                return;
            }
            try {
                const response = await fetch('/adoption-terms');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const content = doc.querySelector('main') || doc.querySelector('body');

                // Remove navigation/back buttons from content
                const nav = content.querySelector('nav');
                if (nav) nav.remove();
                const backButtons = content.querySelectorAll('a[href*="adoption-form"], a[href*="/cats"], button[onclick*="back"]');
                backButtons.forEach(btn => btn.remove());

                this.termsContent = content.innerHTML;
                this.termsModalOpen = true;
            } catch (error) {
                console.error('Error loading terms:', error);
                alert('Unable to load terms. Please try again.');
            }
        },
        async loadPrivacy() {
            if (this.privacyContent) {
                this.privacyModalOpen = true;
                return;
            }
            try {
                const response = await fetch('/privacy-policy');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const content = doc.querySelector('main') || doc.querySelector('body');

                // Remove navigation/back buttons from content
                const nav = content.querySelector('nav');
                if (nav) nav.remove();
                const backButtons = content.querySelectorAll('a[href*="adoption-form"], a[href*="/cats"], button[onclick*="back"]');
                backButtons.forEach(btn => btn.remove());

                this.privacyContent = content.innerHTML;
                this.privacyModalOpen = true;
            } catch (error) {
                console.error('Error loading privacy policy:', error);
                alert('Unable to load privacy policy. Please try again.');
            }
        }
    }
}
</script>

<div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50" x-data="formModals()" @keydown.escape.window="termsModalOpen = false; privacyModalOpen = false">
    <div class="container mx-auto px-4 py-12">
        <!-- Back/Close Button -->
        <div class="mb-6 flex justify-between items-center max-w-2xl mx-auto">
            <a href="/cats" class="inline-flex items-center text-amber-600 hover:text-amber-700 transition-colors font-semibold">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Available Kittens
            </a>
            <button onclick="window.location.href='/cats'" class="text-gray-500 hover:text-gray-700 transition-colors">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-bold text-gray-800 mb-4">üê± Adoption Request</h1>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">Ready to welcome a Siberian cat into your home? Please fill out this form so we can learn more about you and ensure the best match.</p>
        </div>

        <!-- Form -->
        <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg p-8">
            <form id="adoptionForm">
                <!-- Basic Information -->
                <div class="mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Contact Information</h3>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                        <input type="email" id="customer_email" name="customer_email" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                        <input type="text" id="customer_name" name="customer_name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" id="phone" name="phone"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                    </div>
                </div>

                <!-- Litter Selection -->
                <div class="mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Cat Selection</h3>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Which litter are you interested in? *</label>
                        <select id="litter_code" name="litter_code" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                            <option value="">Select a litter...</option>
                        </select>
                    </div>
                </div>

                <!-- Dynamic Questions -->
                <div id="dynamicQuestions" class="mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Additional Information</h3>
                    <div class="text-center">
                        <div class="spinner-border text-amber-600" role="status">
                            <span class="visually-hidden">Loading questions...</span>
                        </div>
                    </div>
                </div>

                <!-- Terms Agreement -->
                <div class="mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-start">
                            <input type="checkbox" id="terms_agreed" name="terms_agreed" required
                                   class="mt-1 h-4 w-4 text-amber-600 focus:ring-amber-500 border-gray-300 rounded">
                            <label for="terms_agreed" class="ml-2 block text-sm text-gray-700">
                                I have read and agree to the <a href="#" @click.prevent="loadTerms()" class="text-amber-600 hover:text-amber-700 underline cursor-pointer">terms of adoption</a> *
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Privacy Consent -->
                <div class="mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex items-start">
                            <input type="checkbox" id="privacy_consent" name="privacy_consent" required
                                   class="mt-1 h-4 w-4 text-amber-600 focus:ring-amber-500 border-gray-300 rounded">
                            <label for="privacy_consent" class="ml-2 block text-sm text-gray-700">
                                I consent to the collection and use of my personal information as described in the <a href="#" @click.prevent="loadPrivacy()" class="text-amber-600 hover:text-amber-700 underline cursor-pointer">privacy policy</a> *
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Subscription -->
                <div class="mb-6">
                    <div class="flex items-start">
                        <input type="checkbox" id="subscription" name="subscription"
                               class="mt-1 h-4 w-4 text-amber-600 focus:ring-amber-500 border-gray-300 rounded">
                        <label for="subscription" class="ml-2 block text-sm text-gray-700">
                            Subscribe to updates about new kittens and farm news
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="text-center">
                    <button type="submit" id="submitBtn"
                            class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-8 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-paper-plane mr-2"></i>Submit Adoption Request
                    </button>
                </div>
            </form>

            <!-- Success/Error Messages -->
            <div id="message" class="mt-6" style="display: none;"></div>
        </div>
    </div>

    <!-- Terms Modal -->
    <div x-show="termsModalOpen" x-cloak @click="termsModalOpen = false" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div @click.stop class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-gradient-to-r from-amber-50 to-orange-50">
                <h2 class="text-2xl font-bold text-gray-800">Terms of Adoption</h2>
                <button @click="termsModalOpen = false" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-88px)]" x-html="termsContent"></div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div x-show="privacyModalOpen" x-cloak @click="privacyModalOpen = false" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div @click.stop class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 bg-gradient-to-r from-amber-50 to-orange-50">
                <h2 class="text-2xl font-bold text-gray-800">Privacy Policy</h2>
                <button @click="privacyModalOpen = false" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-88px)]" x-html="privacyContent"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadLitters();
    loadQuestions();

    // Check if litter is passed in URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const litterCode = urlParams.get('litter');
    if (litterCode) {
        // Wait a bit for litters to load, then select the one from URL
        setTimeout(() => {
            const litterSelect = document.getElementById('litter_code');
            const option = Array.from(litterSelect.options).find(opt => opt.value === litterCode);
            if (option) {
                litterSelect.value = litterCode;
            }
        }, 500);
    }
});

async function loadLitters() {
    try {
        const response = await fetch('/api/cats/');
        const cats = await response.json();

        const litterSelect = document.getElementById('litter_code');
        const litters = new Set();

        // Collect unique available litters
        cats.forEach(cat => {
            if (cat.is_available) {
                litters.add(cat.litter_code);
            }
        });

        // Add options to select
        Array.from(litters).sort().forEach(litter => {
            const option = document.createElement('option');
            option.value = litter;
            option.textContent = `Litter ${litter}`;
            litterSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading litters:', error);
    }
}

async function loadQuestions() {
    try {
        const response = await fetch('/api/adoption/form');
        const questions = await response.json();
        renderQuestions(questions);
    } catch (error) {
        console.error('Error loading questions:', error);
        document.getElementById('dynamicQuestions').innerHTML = '<div class="alert alert-warning">Unable to load questions. Please try again later.</div>';
    }
}

function renderQuestions(questions) {
    const container = document.getElementById('dynamicQuestions');

    if (questions.length === 0) {
        container.innerHTML = '<p class="text-gray-600">No additional questions configured.</p>';
        return;
    }

    let html = '';
    questions.forEach(question => {
        html += `<div class="mb-4">`;
        html += `<label class="block text-sm font-medium text-gray-700 mb-2">${question.question_text}${question.is_required ? ' *' : ''}</label>`;

        if (question.question_type === 'text') {
            html += `<input type="text" name="q_${question.id}" ${question.is_required ? 'required' : ''}
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">`;
        } else if (question.question_type === 'textarea') {
            html += `<textarea name="q_${question.id}" rows="4" ${question.is_required ? 'required' : ''}
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"></textarea>`;
        } else if (question.question_type === 'checkbox') {
            // Render as Yes/No radio buttons for better UX
            html += `<div class="space-y-2">`;
            html += `<div class="flex items-center">
                        <input type="radio" name="q_${question.id}" value="Yes" ${question.is_required ? 'required' : ''}
                               class="h-4 w-4 text-amber-600 focus:ring-amber-500 border-gray-300">
                        <label class="ml-2 block text-sm text-gray-700">Yes</label>
                     </div>`;
            html += `<div class="flex items-center">
                        <input type="radio" name="q_${question.id}" value="No" ${question.is_required ? 'required' : ''}
                               class="h-4 w-4 text-amber-600 focus:ring-amber-500 border-gray-300">
                        <label class="ml-2 block text-sm text-gray-700">No</label>
                     </div>`;
            html += `</div>`;
        } else if (question.question_type === 'radio') {
            if (question.options && question.options.trim()) {
                // Handle both comma-separated and newline-separated options
                let options = [];
                if (question.options.includes('\n')) {
                    options = question.options.split('\n').filter(opt => opt.trim());
                } else if (question.options.includes(',')) {
                    options = question.options.split(',').filter(opt => opt.trim());
                } else {
                    options = [question.options];
                }

                html += `<div class="space-y-2">`;
                options.forEach(option => {
                    html += `<div class="flex items-center">
                                <input type="radio" name="q_${question.id}" value="${option.trim()}" ${question.is_required ? 'required' : ''}
                                       class="h-4 w-4 text-amber-600 focus:ring-amber-500 border-gray-300">
                                <label class="ml-2 block text-sm text-gray-700">${option.trim()}</label>
                             </div>`;
                });
                html += `</div>`;
            } else {
                // No options provided - show error message
                html += `<div class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm">
                            Error: No options configured for this radio question. Please contact the administrator.
                         </div>`;
            }
        } else if (question.question_type === 'select') {
            if (question.options && question.options.trim()) {
                // Handle both comma-separated and newline-separated options
                let options = [];
                if (question.options.includes('\n')) {
                    options = question.options.split('\n').filter(opt => opt.trim());
                } else if (question.options.includes(',')) {
                    options = question.options.split(',').filter(opt => opt.trim());
                } else {
                    options = [question.options];
                }

                html += `<select name="q_${question.id}" ${question.is_required ? 'required' : ''}
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">`;
                html += `<option value="">Select an option</option>`;
                options.forEach(option => {
                    html += `<option value="${option.trim()}">${option.trim()}</option>`;
                });
                html += `</select>`;
            } else {
                // No options provided - show error message
                html += `<div class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm">
                            Error: No options configured for this select question. Please contact the administrator.
                         </div>`;
            }
        } else {
            // Fallback for unknown types
            html += `<div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm">
                        <p class="font-semibold mb-1">Unknown question type: ${question.question_type}</p>
                        <input type="text" name="q_${question.id}" ${question.is_required ? 'required' : ''}
                               class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                               placeholder="Please enter your answer">
                     </div>`;
        }

        html += `</div>`;
    });

    container.innerHTML = `<h3 class="text-xl font-semibold text-gray-800 mb-4">Additional Information</h3>${html}`;
}

document.getElementById('adoptionForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Client-side validation
    const termsAgreed = document.getElementById('terms_agreed').checked;
    if (!termsAgreed) {
        const messageDiv = document.getElementById('message');
        messageDiv.className = 'alert alert-danger';
        messageDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>You must agree to the terms and conditions to submit this form.';
        messageDiv.style.display = 'block';
        messageDiv.scrollIntoView({ behavior: 'smooth' });
        return;
    }

    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';

    const formData = new FormData(e.target);
    const data = {
        customer_email: formData.get('customer_email'),
        customer_name: formData.get('customer_name'),
        phone: formData.get('phone'),
        litter_code: formData.get('litter_code'),
        custom_answers: {},
        terms_agreed: formData.get('terms_agreed') === 'on',
        privacy_consent: formData.get('privacy_consent') === 'on',
        subscription: formData.get('subscription') === 'on'
    };

    // Collect dynamic answers
    for (let [key, value] of formData.entries()) {
        if (key.startsWith('q_')) {
            const questionId = key.replace('q_', '');
            data.custom_answers[questionId] = value;
        }
    }

    try {
        const response = await fetch('/api/adoption/submit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const result = await response.json();
        const messageDiv = document.getElementById('message');

        if (response.ok) {
            messageDiv.className = 'alert alert-success';
            messageDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Thank you! Your adoption request has been submitted successfully. We will review it and contact you soon.';
            e.target.reset();
        } else {
            messageDiv.className = 'alert alert-danger';
            messageDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${result.detail || 'An error occurred. Please try again.'}`;
        }

        messageDiv.style.display = 'block';
        messageDiv.scrollIntoView({ behavior: 'smooth' });

    } catch (error) {
        console.error('Error submitting form:', error);
        const messageDiv = document.getElementById('message');
        messageDiv.className = 'alert alert-danger';
        messageDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Network error. Please check your connection and try again.';
        messageDiv.style.display = 'block';
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});
</script>

<style>
.spinner-border {
    border: 0.25em solid #f3f3f3;
    border-top: 0.25em solid #d97706;
    border-radius: 50%;
    width: 1rem;
    height: 1rem;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.alert {
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.alert-success {
    color: #065f46;
    background-color: #d1fae5;
    border-color: #a7f3d0;
}

.alert-danger {
    color: #991b1b;
    background-color: #fee2e2;
    border-color: #fecaca;
}

.alert-warning {
    color: #92400e;
    background-color: #fef3c7;
    border-color: #fde68a;
}
</style>
</body>
</html>
